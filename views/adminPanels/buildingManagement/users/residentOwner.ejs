<style>
    #usersTable tbody tr:hover {
        background-color: #f9fafb;
    }
    .dataTables_length,
    .dataTables_filter,
    .dataTables_info,
    .dataTables_paginate {
        display: none !important;
    }
</style>

<div
    class="bg-white rounded-tl-[40px] rounded-br-[90px] p-6 shadow-md flex justify-between items-center"
>
    <h1 class="text-2xl font-medium text-gray-500">Users</h1>
    <div class="flex items-center gap-4">
        <!-- Tab Buttons -->
        <div class="bg-[#F3F2F1] rounded-lg flex items-center">
            <button
                onclick="window.location.href='<%= process.env.APP_URL_ADMIN %>/bmadmin/users/residentowner'"
                id="btn-resident"
                class="px-4 py-2 rounded-lg text-white bg-[#54B7C5] transition-all"
            >
                Resident/Owner
            </button>
            <button
                onclick="window.location.href='<%= process.env.APP_URL_ADMIN %>/bmadmin/users/security'"
                id="btn-security"
                class="px-4 py-2 rounded-lg text-gray-600 hover:text-black transition-all"
            >
                Security
            </button>
            <button
                onclick="window.location.href='<%= process.env.APP_URL_ADMIN %>/bmadmin/users/technician'"
                id="btn-technician"
                class="px-4 py-2 rounded-lg text-gray-600 hover:text-black transition-all"
            >
                Technician
            </button>
        </div>

        <!-- File icon at the start -->
        <button
            class="flex items-center m-2 mr-5"
            data-modal-target="reports-modal"
            data-modal-toggle="reports-modal"
        >
            <svg
                class="w-6 h-6 text-gray-800 transform scale-x-[-1]"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                viewBox="0 0 24 24"
            >
                <path
                    stroke="#163f75"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 3v4a1 1 0 0 1-1 1H5m4 8h6m-6-4h6m4-8v16a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V7.914a1 1 0 0 1 .293-.707l3.914-3.914A1 1 0 0 1 9.914 3H18a1 1 0 0 1 1 1Z"
                />
            </svg>
        </button>
    </div>
</div>

<div class="p-7">
    <div class="gap-4 py-2 px-4 items-center mb-3">
        <!-- Request Type Buttons -->
        <div class="flex justify-end items-center space-x-3">
            <div class="flex items-center mt-5 gap-2 text-sm text-gray-700 mb-4">
                <label for="customLength">Show</label>
                <select id="customLength" class="border rounded-md px-2 py-1">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
                <span>entries</span>
            </div>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg
                        class="h-5 w-5 text-gray-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        />
                    </svg>
                </div>
                <input
                    id="searchForUsersList"
                    type="text"
                    placeholder="Search"
                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-1 focus:ring-[#54B7C5] focus:border-[#54B7C5] sm:text-sm"
                />
            </div>
            <button
                class="bg-white text-sm font-semibold text-[#163F75] border border-[2px] border-gray-300 px-8 py-2.5 rounded-xl hover:bg-[#163F75]/10 transition"
                data-modal-target="add-user-modal"
                data-modal-toggle="add-user-modal"
            >
                + Add Resident/Owner
            </button>
        </div>
    </div>
    <!-- DataTable Section -->
    <div class="relative overflow-y-auto max-h-[500px] border rounded-lg">
        <table id="usersTable" class="min-w-full divide-y divide-gray-200" datatables="true">
            <thead class="sticky top-0 z-10 bg-[#EAEAE9] rounded-t-[30px]">
                <tr>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider first:rounded-l-lg last:rounded-r-lg"
                    >
                        Flat/Villa
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Building/Complex
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        User Name
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        IDno.
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Nationality
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Contact No.
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Emergency No.
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Property
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Ownership
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Association
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider"
                    >
                        Agreement
                    </th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider last:rounded-r-lg"
                    >
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200"></tbody>
        </table>
    </div>
    <div id="customPagination" class="flex justify-center mt-4 gap-2"></div>
</div>

<!-- add User Details Modal -->
<div
    id="add-user-modal"
    tabindex="-1"
    class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto h-modal md:h-full"
    aria-hidden="true"
>
    <div class="bg-[#F7F6F5] rounded-2xl shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Add Resident/Owner</h3>
            <button
                data-modal-hide="add-user-modal"
                class="text-red-400 hover:text-red-600 text-2xl"
            >
                Close &times;
            </button>
        </div>
        <form id="add-users-form" method="post" enctype="multipart/form-data">
            <div class="p-6">
                <div class="flex justify-center mb-6">
                    <div class="relative w-24 h-24">
                        <div
                            id="profilePlaceholder"
                            class="w-[95px] h-[95px] rounded-full border-4 border-[#57C1D1] flex items-center justify-center bg-gray-100 overflow-hidden"
                        >
                            <svg
                                class="w-10 h-10 text-gray-500"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M7 17v1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1a3 3 0 0 0-3-3h-4a3 3 0 0 0-3 3Zm8-9a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                                />
                            </svg>
                        </div>
                        <input
                            id="imageUpload"
                            name="personalPhoto"
                            type="file"
                            accept="image/*"
                            class="hidden"
                        />
                        <label
                            for="imageUpload"
                            class="absolute bottom-0 right-0 bg-[#57C1D1] text-white p-2 rounded-full shadow-[0px_4px_10px_rgba(0,0,0,0.05)] cursor-pointer"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                                />
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                                />
                            </svg>
                        </label>
                    </div>
                </div>
                <div class="space-y-5">
                    <div class="">
                        <input
                            name="fullName"
                            type="text"
                            placeholder="Full Name"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input
                            name="IDno"
                            type="text"
                            placeholder="ID No."
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />
                        <div>
                            <select
                                name="nationality"
                                class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                            >
                                <option value="" disabled selected>Nationality</option>
                                <% nationality.forEach(n => { %>
                                <option value="<%= n._id %>"><%= n.name %></option>
                                <% }) %>
                            </select>
                        </div>
                    </div>
                    <div>
                        <select
                            name="buildingOrComplexName"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <option value="" disabled selected>Building/Complex Name</option>
                            <% buildingOrComplex.forEach(b => { %>
                            <option value="<%= b._id %>"><%= b.buildingNameOrAreaName %></option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input
                            name="flatVillaNumber"
                            type="text"
                            placeholder="Flat/Villa"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />

                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="associationMember"
                                id="associationMember"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="associationMember" class="ml-2 text-sm text-gray-700">
                                Association Member
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="resident"
                                id="resident"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="resident" class="ml-2 text-sm text-gray-700">
                                Resident
                            </label>
                        </div>

                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="owner"
                                id="owner"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="owner" class="ml-2 text-sm text-gray-700">Owner</label>
                        </div>
                    </div>
                    <div
                        class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="relative flex items-center mr-3">
                            <select
                                name="countryCode1"
                                class="z-10 absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="updateFlag(this)"
                                data-flag-id="contact-no-flag"
                                data-code-id="contact-no-code"
                            >
                                <% countries.forEach((country, index) => { %>
                                <option 
                                            value="<%= country.countryCode %>" 
                                            data-flag="<%= country.flag %>"
                                            <%= index === 0 ? 'selected' : '' %>
                                        >
                                            <%= country.countryCode %> <%= country.name %>
                                        </option>
                                <% }) %>
                            </select>

                            <img
                                id="contact-no-flag"
                                src="<%= countries[0]?.flag %>"
                                class="w-10 h-6 object-cover border rounded-sm z-0"
                                alt="Country flag"
                            />

                            <svg
                                class="w-2.5 h-2.5 text-gray-600 ml-1 pointer-events-none"
                                fill="none"
                                viewBox="0 0 10 6"
                            >
                                <path stroke="currentColor" stroke-width="2" d="M1 1l4 4 4-4" />
                            </svg>
                        </div>
                        <input
                            name="contactNumber"
                            type="text"
                            placeholder="Contact Number"
                            class="w-full bg-transparent focus:outline-none text-sm placeholder-gray-400"
                        />
                    </div>
                    <div
                        class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="relative flex items-center mr-3">
                            <select
                                name="countryCode2"
                                class="z-10 absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="updateFlag(this)"
                                data-flag-id="emergency-no-flag"
                                data-code-id="emergency-no-code"
                            >
                                <% countries.forEach((country, index) => { %>
                                <option 
                                            value="<%= country.countryCode %>" 
                                            data-flag="<%= country.flag %>"
                                            <%= index === 0 ? 'selected' : '' %>
                                        >
                                            <%= country.countryCode %> <%= country.name %>
                                        </option>
                                <% }) %>
                            </select>

                            <img
                                id="emergency-no-flag"
                                src="<%= countries[0]?.flag %>"
                                class="w-10 h-6 object-cover border rounded-sm z-0"
                                alt="Country flag"
                            />

                            <svg
                                class="w-2.5 h-2.5 text-gray-600 ml-1 pointer-events-none"
                                fill="none"
                                viewBox="0 0 10 6"
                            >
                                <path stroke="currentColor" stroke-width="2" d="M1 1l4 4 4-4" />
                            </svg>
                        </div>
                        <input
                            name="emergencyNumber"
                            type="text"
                            placeholder="Emergency Number"
                            class="w-full bg-transparent focus:outline-none text-sm placeholder-gray-400"
                        />
                    </div>
                </div>
                <div class="flex items-center justify-center mt-4">
                    <label
                        class="flex items-center justify-center w-full h-16 bg-white border border-dashed border-gray-300 rounded-xl cursor-pointer shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5 text-gray-500"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0l-4 4m4-4v12"
                                />
                            </svg>
                            <span>Please Upload Agreement Here (PDF)</span>
                        </div>
                        <input name="agreementPdf" type="file" class="hidden" />
                    </label>
                </div>
                <div class="flex justify-center p-6 border-t border-gray-200">
                    <button
                        type="submit"
                        class="bg-[#57C1D1] hover:bg-[#4BB3C2] text-white py-3 px-9 rounded-lg font-medium text-base shadow-[0px_4px_10px_rgba(0,0,0,0.05)] transition"
                    >
                        Save
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- edit User Details Modal -->
<div
    id="edit-user-modal"
    tabindex="-1"
    class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto h-modal md:h-full"
    aria-hidden="true"
>
    <div class="bg-[#F7F6F5] rounded-2xl shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Edit Resident/Owner</h3>
            <button
                data-modal-hide="edit-user-modal"
                class="text-red-400 hover:text-red-600 text-2xl"
            >
                Close &times;
            </button>
        </div>
        <form id="editUserForm" enctype="multipart/form-data">
            <input type="hidden" id="editUserId" name="editUserId" />
            <div class="p-6">
                <div class="flex justify-center mb-6">
                    <div class="relative w-24 h-24">
                        <div
                            id="profilePlaceholder"
                            class="w-[95px] h-[95px] rounded-full border-4 border-[#57C1D1] flex items-center justify-center bg-gray-100 overflow-hidden"
                        >
                            <img
                                id="editProfileImage"
                                src="<%= process.env.APP_ADMIN_URL %>/Icons/images/securityimage.png"
                                class="w-full h-full object-cover rounded-full"
                            />
                        </div>
                        <input
                            id="imageUpload"
                            name="personalPhoto"
                            type="file"
                            accept="image/*"
                            class="hidden"
                        />
                        <label
                            for="imageUpload"
                            class="absolute bottom-0 right-0 bg-[#57C1D1] text-white p-2 rounded-full shadow-[0px_4px_10px_rgba(0,0,0,0.05)] cursor-pointer"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                                />
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                                />
                            </svg>
                        </label>
                    </div>
                </div>
                <div class="space-y-5">
                    <div class="">
                        <input
                            id="fullName"
                            name="fullName"
                            type="text"
                            placeholder="Full Name"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input
                            id="IDno"
                            name="IDno"
                            type="text"
                            placeholder="ID No."
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />
                        <div>
                            <select
                                name="nationality"
                                id="nationality"
                                class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                            >
                                <option value="" disabled selected>Nationality</option>
                                <% nationality.forEach(n => { %>
                                <option value="<%= n._id %>"><%= n.name %></option>
                                <% }) %>
                            </select>
                        </div>
                    </div>
                    <div>
                        <select
                            name="buildingOrComplexName"
                            id="buildingOrComplexName"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <option value="" disabled selected>Building/Complex Name</option>
                            <% buildingOrComplex.forEach(b => { %>
                            <option value="<%= b._id %>"><%= b.buildingNameOrAreaName %></option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input
                            id="flatVillaNumber"
                            name="flatVillaNumber"
                            type="text"
                            placeholder="Flat/Villa"
                            class="w-full px-4 py-3 bg-white rounded-xl text-gray-700 text-sm focus:outline-none placeholder-gray-500 shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        />

                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="associationMember"
                                id="editassociationMember"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="associationMember" class="ml-2 text-sm text-gray-700">
                                Association Member
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="resident"
                                id="editresident"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="resident" class="ml-2 text-sm text-gray-700">
                                Resident
                            </label>
                        </div>

                        <div
                            class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                        >
                            <input
                                name="owner"
                                id="editowner"
                                type="checkbox"
                                class="w-4 h-4 text-[#57C1D1] focus:ring-[#57C1D1] border border-gray-300 rounded"
                            />
                            <label for="owner" class="ml-2 text-sm text-gray-700">Owner</label>
                        </div>
                    </div>
                    <div
                        class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="relative flex items-center mr-3">
                            <select
                                id="countryCode1"
                                name="countryCode1"
                                class="z-10 absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="updateFlag(this)"
                                data-flag-id="edit-contact-no-flag"
                                data-code-id="edit-contact-no-code"
                            >
                                <% countries.forEach((country, index) => { %>
                                <option 
                                            value="<%= country.countryCode %>" 
                                            data-flag="<%= country.flag %>"
                                            <%= index === 0 ? 'selected' : '' %>
                                        >
                                            <%= country.countryCode %> <%= country.name %>
                                        </option>
                                <% }) %>
                            </select>

                            <img
                                id="edit-contact-no-flag"
                                src="<%= countries[0]?.flag %>"
                                class="w-10 h-6 object-cover border rounded-sm z-0"
                                alt="Country flag"
                            />

                            <svg
                                class="w-2.5 h-2.5 text-gray-600 ml-1 pointer-events-none"
                                fill="none"
                                viewBox="0 0 10 6"
                            >
                                <path stroke="currentColor" stroke-width="2" d="M1 1l4 4 4-4" />
                            </svg>
                        </div>
                        <input
                            name="contactNumber"
                            id="contactNumber"
                            type="text"
                            placeholder="Contact Number"
                            class="w-full bg-transparent focus:outline-none text-sm placeholder-gray-400"
                        />
                    </div>
                    <div
                        class="flex items-center px-4 py-3 bg-white rounded-xl shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="relative flex items-center mr-3">
                            <select
                                id="countryCode2"
                                name="countryCode2"
                                class="z-10 absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="updateFlag(this)"
                                data-flag-id="edit-emergency-no-flag"
                                data-code-id="edit-emergency-no-code"
                            >
                                <% countries.forEach((country, index) => { %>
                                <option 
                                            value="<%= country.countryCode %>" 
                                            data-flag="<%= country.flag %>"
                                            <%= index === 0 ? 'selected' : '' %>
                                        >
                                            <%= country.countryCode %> <%= country.name %>
                                        </option>
                                <% }) %>
                            </select>

                            <img
                                id="edit-emergency-no-flag"
                                src="<%= countries[0]?.flag %>"
                                class="w-10 h-6 object-cover border rounded-sm z-0"
                                alt="Country flag"
                            />

                            <svg
                                class="w-2.5 h-2.5 text-gray-600 ml-1 pointer-events-none"
                                fill="none"
                                viewBox="0 0 10 6"
                            >
                                <path stroke="currentColor" stroke-width="2" d="M1 1l4 4 4-4" />
                            </svg>
                        </div>
                        <input
                            id="emergencyNumber"
                            name="emergencyNumber"
                            type="text"
                            placeholder="Emergency Number"
                            class="w-full bg-transparent focus:outline-none text-sm placeholder-gray-400"
                        />
                    </div>
                </div>
                <div id="agreementpdfeditdiv" class="flex items-center justify-center mt-4">
                    <label
                        class="flex items-center justify-center w-full h-16 bg-white border border-dashed border-gray-300 rounded-xl cursor-pointer shadow-[0px_4px_10px_rgba(0,0,0,0.05)]"
                    >
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5 text-gray-500"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0l-4 4m4-4v12"
                                />
                            </svg>
                            <span>Please Upload Agreement Here (PDF)</span>
                        </div>
                        <input name="agreementPdf" id="editPdf" type="file" class="hidden" />
                    </label>
                </div>
                <div id="existingPdfContainer" class="m-3 flex items-center justify-center gap-2">
                    <span id="existingPdfName" class="text-md text-gray-600"></span>
                    <button type="button" id="removePdfBtn" class="text-red-500 text-xs">
                        Remove
                    </button>
                </div>
                <div class="flex justify-center p-6 border-t border-gray-200">
                    <button
                        type="submit"
                        class="bg-[#57C1D1] hover:bg-[#4BB3C2] text-white py-3 px-9 rounded-lg font-medium text-base shadow-[0px_4px_10px_rgba(0,0,0,0.05)] transition"
                    >
                        Save
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Reports Modal -->
<div
    id="reports-modal"
    tabindex="-1"
    class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto h-modal md:h-full"
    aria-hidden="true"
>
    <!-- Modal Container -->
    <div class="bg-[#F7F6F5] rounded-2xl shadow-xl w-full max-w-md">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Reports</h3>
            <button
                data-modal-hide="reports-modal"
                class="text-red-400 hover:text-red-600 text-2xl"
            >
                Close &times;
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <div class="flex flex-col space-y-3">
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <div class="relative">
                        <div
                            class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"
                        >
                            <svg
                                class="w-4 h-4 text-gray-500"
                                aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"
                                />
                            </svg>
                        </div>
                        <input
                            datepicker
                            datepicker-orientation="bottom"
                            datepicker-format="dd-mm-yyyy"
                            type="text"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5"
                            placeholder="Select date"
                        />
                    </div>
                </div>

                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <div class="relative">
                        <div
                            class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"
                        >
                            <svg
                                class="w-4 h-4 text-gray-500"
                                aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"
                                />
                            </svg>
                        </div>
                        <input
                            datepicker
                            datepicker-orientation="bottom"
                            datepicker-format="dd-mm-yyyy"
                            type="text"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5"
                            placeholder="Select date"
                        />
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-center p-6 gap-2 border-gray-200">
                <button
                    class="bg-[#57C1D1] hover:bg-[#4BB3C2] text-white py-3 px-16 rounded-lg font-medium text-base shadow-[0px_4px_10px_rgba(0,0,0,0.05)] transition"
                >
                    View
                </button>
                <button
                    class="bg-[#163F75] hover:bg-[#163F75]/90 text-white py-3 px-16 rounded-lg font-medium text-base shadow-[0px_4px_10px_rgba(0,0,0,0.05)] transition"
                >
                    Extract
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.min.css" />

<script>
    function updateFlag(selectEl) {
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        const flagUrl = selectedOption.dataset.flag;
        const countryCode = selectedOption.value;

        const flagImgId = selectEl.dataset.flagId;
        const codeSpanId = selectEl.dataset.codeId;

        if (flagImgId && flagUrl) {
            const flagImg = document.getElementById(flagImgId);
            if (flagImg) flagImg.src = flagUrl;
        }

        if (codeSpanId) {
            const codeSpan = document.getElementById(codeSpanId);
            if (codeSpan) codeSpan.innerText = countryCode;
        }
    }

    const imageUpload = document.getElementById("imageUpload");
    const profilePlaceholder = document.getElementById("profilePlaceholder");

    imageUpload.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                profilePlaceholder.innerHTML = `
              <img src="${e.target.result}" alt="Profile" class="w-full h-full object-cover rounded-full" />
            `;
            };
            reader.readAsDataURL(file);
        }
    });

    $("#add-users-form").on("submit", function (e) {
        e.preventDefault();
        const form = new FormData(this);
        $.ajax({
            type: "POST",
            url: "/bmadmin/users/residentowner",
            data: form,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    window.location.href = `/bmadmin/users/residentowner`;
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: response.message,
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                    });
                }
            },
            error: function (err) {
                console.error(err);
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: err.message,
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
            },
        });
    });

    $(document).ready(function () {
        if ($.fn.DataTable) {
            const table = $("#usersTable").DataTable({
                dom: "t", // ✅ keeps backend search logic, hides default search box
                responsive: true,
                ordering: true,
                searching: true,
                serverSide: true,
                processing: true,
                order: [], // ✅ disables initial ordering from table headers
                ajax: {
                    url: "/bmadmin/users/residentowner/list",
                    type: "GET",
                    data: function (d) {
                        d.customSearch = $("#searchForUsersList").val(); // ✅ Send manually as a simple string
                    },
                },
                columns: [
                    {
                        data: "flatVillaNumber",
                        class: "px-6 py-3 text-center text-xs font-medium text-black uppercase tracking-wider first:rounded-l-lg last:rounded-r-lg",
                    },
                    {
                        data: "buildingOrComplexName",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            if (data && data.buildingNameOrAreaName) {
                                return data.buildingNameOrAreaName;
                            } else {
                                return "N/A";
                            }
                        },
                    },
                    {
                        data: null,
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900",
                        render: function (data, type, row) {
                            const name = row.fullName || "N/A";
                            const photoUrl = row.personalPhoto || "/images/default-user.png";

                            return `
            <div class="flex items-center gap-3">
                <img src="${photoUrl}" alt="${name}" class="w-10 h-10 rounded-full object-cover" />
                <span class="text-sm font-medium text-gray-800">${name}</span>
            </div>
        `;
                        },
                    },
                    {
                        data: "IDno",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                    },
                    {
                        data: "nationality",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data) {
                            if (data && data.name && data.flag) {
                                return `
            <div class="flex items-center gap-2">
              <img src="${data.flag}" class="w-9 h-6 object-cover rounded-sm border" />
              <span class="text-sm font-medium text-gray-800">${data.name}</span>
            </div>`;
                            } else {
                                return "N/A";
                            }
                        },
                    },
                    {
                        data: null,
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            const code = data.countryCode1;
                            const num = data.contactNumber;
                            return code + " " + num;
                        },
                    },
                    {
                        data: null,
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            const code = data.countryCode2;
                            const emnum = data.emergencyNumber;
                            return code + " " + emnum;
                        },
                    },
                    {
                        data: "resident",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            if (data === true) {
                                return "Resident";
                            } else {
                                return "-";
                            }
                        },
                    },
                    {
                        data: "owner",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            if (data === true) {
                                return "Owner";
                            } else {
                                return "-";
                            }
                        },
                    },
                    {
                        data: "associationMember",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            if (data === true) {
                                return "Member";
                            } else {
                                return "-";
                            }
                        },
                    },
                    {
                        data: "agreementPdf",
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            if (!data) return "N/A";

                            const pdfIcon = `${window.location.origin}/Icons/images/pdf.png`;
                            const fileUrl = `${window.location.origin}/${data}`;

                            return `
            <a href="${fileUrl}" download target="_blank">
                <img src="${pdfIcon}" alt="Download PDF" class="w-7 h-8 mx-auto object-cover" />
            </a>`;
                        },
                    },
                    {
                        data: null,
                        class: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center",
                        render: function (data, row, type) {
                            return `<button
                                onclick="deleteUser('${data._id}')"
                                class="delete-user-btn inline-flex items-center mr-2 px-3 py-2"
                            >
                                <svg
                                    class="w-6 h-6 text-gray-800 dark:text-white"
                                    aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke="#F26E6E"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"
                                    />
                                </svg>
                            </button>
                            <button
                                type="button"
                                data-id="${data._id}"
                                data-modal-target="edit-user-modal"
                                data-modal-toggle="edit-user-modal"
                                class="edit-user-btn inline-flex items-center"
                            >
                                <svg
                                    class="w-6 h-6 text-gray-800 dark:text-white"
                                    aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke="#54B7C5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"
                                    />
                                </svg>
                            </button>`;
                        },
                    },
                ],
            });
            // ✅ Custom Search Input Handler
            let searchTimeout;
            $("#searchForUsersList").on("input", function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    table.page(0).draw("page"); // 👈 force to first page
                }, 300);
            });

            // ✅ Page length dropdown
            $("#customLength").on("change", function () {
                table.page.len(this.value).draw();
            });

            // ✅ Custom Pagination Renderer
            function renderPagination(table) {
                const pagination = $("#customPagination");
                pagination.html(""); // clear old

                const info = table.page.info();
                const currentPage = info.page + 1;
                const totalPages = info.pages;

                for (let i = 1; i <= totalPages; i++) {
                    const btn = $(
                        `<button class="px-3 py-1 rounded-lg text-sm font-medium ${
                            i === currentPage
                                ? "bg-[#54B7C5] text-white"
                                : "bg-gray-100 text-gray-800"
                        }">${i}</button>`
                    );
                    btn.on("click", () => {
                        table.page(i - 1).draw("page");
                    });
                    pagination.append(btn);
                }
            }

            // Draw pagination when table changes
            table.on("draw", function () {
                renderPagination(table);
            });

            const selectedContactFlag = $("#countryCode1 option:selected").data(
                "edit-contact-no-flag"
            );

            const selectedEmergencyFlag = $("#countryCode2 option:selected").data(
                "edit-emergency-no-flag"
            );

            $("#usersTable").on("click", ".edit-user-btn", function () {
                const rowData = $("#usersTable").DataTable().row($(this).closest("tr")).data();
                $("#editUserId").val(rowData._id);
                $("#editProfileImage").attr(
                    "src",
                    rowData.personalPhoto || "/images/default-user.png"
                );
                $("#fullName").val(rowData.fullName);
                $("#IDno").val(rowData.IDno);
                $("#nationality").val(rowData.nationality?._id);
                $("#buildingOrComplexName").val(rowData.buildingOrComplexName?._id);
                $("#flatVillaNumber").val(rowData.flatVillaNumber);
                $("#editresident").prop("checked", rowData.resident === true);
                $("#editowner").prop("checked", rowData.owner === true);
                $("#editassociationMember").prop("checked", rowData.associationMember === true);
                $("#contactNumber").val(rowData.contactNumber);
                $("#emergencyNumber").val(rowData.emergencyNumber);
                $("#countryCode1").val(rowData.countryCode1).trigger("change");
                $("#countryCode2").val(rowData.countryCode2).trigger("change");

                const emergencyFlag = $(`#countryCode2 option:selected`).data("flag");
                const contactFlag = $(`#countryCode1 option:selected`).data("flag");

                $("#edit-emergency-no-flag").attr("src", emergencyFlag);
                $("#edit-contact-no-flag").attr("src", contactFlag);

                if (rowData.agreementPdf) {
                    const fileName = rowData.agreementPdf.split("/").pop();
                    $("#existingPdfName").text(fileName);
                    $("#existingPdfContainer").show();
                    $("#agreementpdfeditdiv").hide();
                } else {
                    $("#agreementpdfeditdiv").show();
                    $("#existingPdfContainer").hide();
                }

                $("#removePdfBtn")
                    .off("click")
                    .on("click", function () {
                        $("#existingPdfName").text("");
                        $("#existingPdfContainer").hide();
                        $("#agreementpdfeditdiv").show();
                        $("#editPdf").val("");
                    });
            });
        } else {
            console.error("DataTables is not loaded");
        }
    });

    // Edit users
    $("#editUserForm").on("submit", function (e) {
        console.log("Edit user form submitted");
        e.preventDefault();

        const userId = $("#editUserId").val();
        const formData = new FormData();

        let member =  $("#editassociationMember").prop("checked") ? true : false;
        let resident = $("#editresident").prop("checked") ? true : false;
        let owner = $("#editowner").prop("checked") ? true : false;

        formData.append("fullName", $("#fullName").val());
        formData.append("IDno", $("#IDno").val());
        formData.append("nationality", $("#nationality").val());
        formData.append("buildingOrComplexName", $("#buildingOrComplexName").val());
        formData.append("flatVillaNumber", $("#flatVillaNumber").val());
        formData.append("associationMember", member);
        formData.append("resident", resident);
        formData.append("owner", owner);
        formData.append("countryCode1", $("#countryCode1").val());
        formData.append("contactNumber", $("#contactNumber").val());
        formData.append("countryCode2", $("#countryCode2").val());
        formData.append("emergencyNumber", $("#emergencyNumber").val());

        const photo = $("#imageUpload")[0].files[0];
        const pdf = $("#editPdf")[0].files[0];

        if (photo) formData.append("personalPhoto", photo);
        if (pdf) formData.append("agreementPdf", pdf);

        $.ajax({
            url: `/bmadmin/users/residentowner/${userId}`,
            type: "PUT",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: response.message,
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                    });
                    window.location.href = `/bmadmin/users/residentowner`;
                }
            },
            error: function () {
                Swal.fire("Error", "Failed to update user", "error");
            },
        });
    });

    function deleteUser(id) {
        console.log("Delete Function Called");
        $.ajax({
            url: `/bmadmin/users/residentowner/${id}`,
            type: "DELETE",
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: response.message,
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                    });
                    setTimeout(() => {
                        window.location.href = `/bmadmin/users/residentowner`;
                    }, 1000);
                }
            },
            error: function () {
                Swal.fire("Error", "Failed to Delete user", "error");
            },
        });
    }
</script>
